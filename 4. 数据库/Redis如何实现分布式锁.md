# Redis如何实现分布式锁
#4. 数据库/Redis#
- - - -
## 分布式锁定义
控制分布式系统有序的去对共享资源进行操作，通过互斥来保持一致性。 举个不太恰当的例子：假设共享的资源就是一个房子，里面有各种书，分布式系统就是要进屋看书的人，分布式锁就是保证这个房子只有一个门并且一次只有一个人可以进，而且门只有一把钥匙。然后许多人要去看书，可以，排队，第一个人拿着钥匙把门打开进屋看书并且把门锁上，然后第二个人没有钥匙，那就等着，等第一个出来，然后你在拿着钥匙进去，然后就是以此类推。
- - - -
## 实现原理
### 实现原理
1. 互斥性
	* 保证同一时间只有一个客户端可以拿到锁，也就是可以对共享资源进行操作
2. 安全性
	* _只有加锁的服务才能有解锁权限_ ，也就是不能让a加的锁，bcd都可以解锁，如果都能解锁那分布式锁就没啥意义了
	* 可能出现的情况就是a去查询发现持有锁，就在准备解锁，这时候忽然a持有的锁过期了，然后b去获得锁，因为a锁过期，b拿到锁，这时候a继续执行第二步进行解锁如果不加校验，就将b持有的锁就给删除了
3. 避免死锁
	* 出现死锁就会导致后续的任何服务都拿不到锁，不能再对共享资源进行任何操作了。
4. 保证加锁与解锁操作是原子性操作
	* 这个其实属于是实现分布式锁的问题，假设a用redis实现分布式锁
	* 假设加锁操作，操作步骤分为两步： 1，设置key set（key，value）2，给key设置过期时间
	* 假设现在a刚实现set后，程序崩了就导致了没给key设置过期时间就导致key一直存在就发生了死锁。
- - - -
## 使用redis实现分布式锁
* 使用redis命令 set key value NX EX max-lock-time 实现加锁
* 使用redis命令 EVAL 实现解锁
	* 加锁操作：jedis.set(key,value,”NX”,”EX”,timeOut)【保证加锁的原子操作】
	* key就是redis的key值作为锁的标识，value在这里作为客户端的标识，只有key-value都比配才有删除锁的权利（保证安全性）
	* 通过timeOut设置过期时间保证不会出现死锁【避免死锁】
	* NX，EX什么意思？
		* NX：只有这个key不存才的时候才会进行操作，if not exists；
		* EX：设置key的过期时间为秒，具体时间由第5个参数决定